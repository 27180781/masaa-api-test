<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>× ×™×”×•×œ ×××’×¨ ××©×—×§×™×</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
        h1, h2 { color: #1d5b85; }
        nav a { margin-left: 20px; font-size: 18px; }
        .container { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; }
        .form-container, .table-container { background-color: #f7f8fb; border: 1px solid #ddd; border-radius: 8px; padding: 20px; }
        textarea { width: 100%; box-sizing: border-box; }
        button { background-color: #27ae60; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        th { background-color: #f2f2f2; }
        td button { background-color: #e74c3c; font-size: 12px; padding: 5px 10px;}
    </style>
</head>
<body>
    <nav>
        <a href="/master_admin">×“×©×‘×•×¨×“ ×¨××©×™</a>
        <a href="/games_admin">× ×™×”×•×œ ××©×—×§×™×</a>
    </nav>
    <h1>× ×™×”×•×œ ×××’×¨ ××–×”×™ ××©×—×§</h1>

    <div class="container">
        <div class="form-container">
            <h2>×”×•×¡×¤×ª ××–×”×™× ×—×“×©×™×</h2>
            <form id="addGamesForm">
                <label for="game_ids">×”×“×‘×§ ×¨×©×™××ª ×¢×¨×›×•×ª (×›×œ ×¢×¨×›×” ×‘×©×•×¨×” ×—×“×©×”):</label>
                <textarea id="game_ids" rows="10" placeholder="×¤×•×¨××˜: ××–×”×”,×©×,××¡×¤×¨ ××©×ª×ª×¤×™×&#10;×œ×“×•×’××”:&#10;GAME123,×œ×§×•×— ×,50&#10;GAME456,×œ×§×•×— ×‘,30"></textarea>
                <br><br>
                <button type="submit">×”×•×¡×£ ×œ×××’×¨</button>
            </form>
        </div>

        <div class="table-container">
            <h2>×¡×˜×˜×•×¡ ××–×”×™ ××©×—×§</h2>
            <table>
                <thead>
                    <tr>
                        <th>××–×”×” ××©×—×§</th>
                        <th>×©×</th>
                        <th>××¡' ××©×ª×ª×¤×™×</th>
                        <th>×¡×˜×˜×•×¡</th>
                        <th>××™×™×œ ××©×•×™×š</th>
                        <th>×ª××¨×™×š ×©×™×•×š</th>
                        <th>×ª××¨×™×š ×¡×™×•×</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="gamesTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const addGamesForm = document.getElementById('addGamesForm');
        const gamesTableBody = document.getElementById('gamesTableBody');

        async function fetchGames() {
            try {
                const response = await fetch('/api/games');
                const games = await response.json();

                gamesTableBody.innerHTML = '';
                games.forEach(game => {
                    const row = document.createElement('tr');
                    let statusText = game.status;
                    if (game.status === 'available') statusText = 'âœ… ×¤× ×•×™';
                    if (game.status === 'assigned') statusText = 'ğŸŸ¡ ××©×•×™×š';
                    if (game.status === 'completed') statusText = 'ğŸ”µ ×”×¡×ª×™×™×';

                    // [×©×™× ×•×™] ×¢×“×›×•×Ÿ ××‘× ×” ×©×•×¨×ª ×”×˜×‘×œ×” ×¢× ×”× ×ª×•× ×™× ×”×—×“×©×™×
                    row.innerHTML = `
                        <td><strong>${game.game_id}</strong></td>
                        <td>${game.name || '-'}</td>
                        <td>${game.participant_count || '-'}</td>
                        <td>${statusText}</td>
                        <td>${game.client_email || '-'}</td>
                        <td>${game.assigned_at ? new Date(game.assigned_at).toLocaleString('he-IL') : '-'}</td>
                        <td>${game.completed_at ? new Date(game.completed_at).toLocaleString('he-IL') : '-'}</td>
                        <td><button onclick="deleteGame('${game.game_id}')">××—×§</button></td>
                    `;
                    gamesTableBody.appendChild(row);
                });
            } catch (error) { console.error('Error fetching games:', error); }
        }

        addGamesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idsText = document.getElementById('game_ids').value;
            
            // [×©×™× ×•×™] ×œ×•×’×™×§×ª ×¤×™×¢× ×•×— ×—×“×©×” ×¢×‘×•×¨ ×¤×•×¨××˜ CSV
            const lines = idsText.split('\n').filter(line => line.trim() !== '');
            const games_data = lines.map(line => {
                const parts = line.split(',');
                if (parts.length < 3) return null; // ×“×¨×•×© ×œ×¤×—×•×ª ××–×”×”, ×©× ×•××¡×¤×¨
                return {
                    game_id: parts[0].trim(),
                    name: parts[1].trim(),
                    participant_count: parseInt(parts[2].trim(), 10)
                };
            }).filter(Boolean); // ×¡× ×Ÿ ×©×•×¨×•×ª ×œ× ×ª×§×™× ×•×ª

            if (games_data.length === 0) return alert('× × ×œ×”×–×™×Ÿ × ×ª×•× ×™× ×‘×¤×•×¨××˜ ×”× ×›×•×Ÿ (××–×”×”,×©×,××¡×¤×¨ ××©×ª×ª×¤×™×)');

            try {
                // [×©×™× ×•×™] ×©×œ×™×—×ª ×”××‘× ×” ×”×—×“×© ×œ×©×¨×ª
                const res = await fetch('/api/games/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ games_data }) // ×©×™× ×•×™ ×”××¤×ª×— ×œ-games_data
                });
                if (res.ok) {
                    document.getElementById('game_ids').value = '';
                    fetchGames();
                } else { alert('Error adding games'); }
            } catch (error) { console.error('Error adding games:', error); }
        });

        async function deleteGame(gameId) {
            if (!confirm(`×”×× ×œ××—×•×§ ××ª ×”××©×—×§ ${gameId}?`)) return;
            try {
                const res = await fetch(`/api/games/${gameId}`, { method: 'DELETE' });
                if (res.ok) fetchGames();
                else alert('Error deleting game');
            } catch(e) { console.error('Error:', e); }
        }

        fetchGames();
    </script>
</body>
</html>