<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转爪转 砖</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; color: #333; text-align: center; }
        h1, h2 { color: #1d5b85; }
        .search-container { background-color: #f7f8fb; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        input[type="text"] { width: 250px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button { background-color: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-right: 5px; }
        button:hover { opacity: 0.9; }
        #resultsContainer { text-align: right; border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .insight-text { font-size: 1.1em; line-height: 1.6; }
        .insight-text p { margin: 10px 0; }
        .insight-text strong { color: #1d5b85; }
        .insight-text ul { padding-right: 20px; }
        /* **砖: 注爪 专 转专砖 转转** */
        .profile-container { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 40px; margin: 20px 0; }
        .chart-container { max-width: 300px; max-height: 300px; }
        #aiInsightButton { background-color: #3498db; margin-top: 15px; }
        #aiInsightResult { background-color: #f7f9fa; border: 1px dashed #3498db; border-radius: 8px; padding: 15px; margin-top: 15px; text-align: right; white-space: pre-wrap; line-height: 1.7; }
    </style>
</head>
<body>
    <h1>住注  转 注爪 - 转爪转 砖</h1>

    <div class="search-container">
        <h2>爪转 转爪转</h2>
        <input type="text" id="searchInput" placeholder="住 拽 砖  住驻专 驻">
        <button id="searchButton">驻砖</button>
    </div>

    <div id="resultsContainer">
        </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsContainer = document.getElementById('resultsContainer');
        let currentUserProfile = null; // **砖: 砖转  砖专转 驻专驻 **

        // **砖:  转专 砖转  注专转**
        const hebrewMap = {
            fire: '砖 ',
            water: ' ',
            air: '专 ',
            earth: ' '
        };
        const elementColors = {
            fire: 'rgba(231, 76, 60, 0.8)',
            water: 'rgba(52, 152, 219, 0.8)',
            air: 'rgba(241, 196, 15, 0.8)',
            earth: 'rgba(46, 204, 113, 0.8)'
        };

        // **砖: 驻拽爪 爪专转 转专砖 注 注 Chart.js**
        function createProfileChart(profile) {
            const labels = Object.keys(profile).map(key => hebrewMap[key]);
            const data = Object.values(profile);
            const colors = Object.keys(profile).map(key => elementColors[key]);

            const chartHtml = '<div class="chart-container"><canvas id="profileChart"></canvas></div>';
            
            // 注 拽   砖-canvas 拽 -DOM 驻 砖爪专 注
            setTimeout(() => {
                const ctx = document.getElementById('profileChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut', // 住 转专砖:  (注 注 专)
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '驻专驻 砖',
                            data: data,
                            backgroundColor: colors,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverOffset: 15 // 驻拽 专祝
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { font: { size: 14 } }
                            }
                        },
                        animation: {
                            animateScale: true, // 爪转 驻转 驻
                            animateRotate: true
                        }
                    }
                });
            }, 0);
            
            return chartHtml;
        }

        function getDominantElement(profile) {
            if (!profile || Object.keys(profile).length === 0) return null;
            return Object.keys(profile).reduce((a, b) => profile[a] > profile[b] ? a : b);
        }

        function generateInsightHTML(profile, insights) {
            if (!insights || !profile) return '<p> 转 转转</p>';

            const dominantElement = getDominantElement(profile);
            let html = `<div class="insight-text">`;
            
            if (dominantElement && insights.dominant_insights && insights.dominant_insights[dominantElement]) {
                html += `<p><strong>转 转 (${hebrewMap[dominantElement]}):</strong> ${insights.dominant_insights[dominantElement]}</p><hr style="margin: 5px 0;">`;
            }

            html += `<p><strong>驻专 住祝:</strong></p><ul>`;
            for (const [element, value] of Object.entries(profile)) {
                if (insights.general_insights && insights.general_insights[element]) {
                    const sortedRules = insights.general_insights[element].sort((a,b) => b.min_percent - a.min_percent);
                    const applicableRule = sortedRules.find(rule => value >= rule.min_percent);
                    if (applicableRule) {
                        // **注: 砖砖  注专转**
                        html += `<li><strong>${hebrewMap[element]}:</strong> ${applicableRule.text}</li>`;
                    }
                }
            }
            html += '</ul>';
            // **砖: 住驻转 驻转专 转转 AI 拽 爪转**
            html += `<button id="aiInsightButton">爪专 转转 AI </button>`;
            html += `<div id="aiInsightResult" style="display: none;"></div>`
            html += `</div>`;
            return html;
        }

        // **砖: 驻拽爪 拽转 转转 AI 砖专转**
        async function getAiInsight() {
            const aiButton = document.getElementById('aiInsightButton');
            const aiResultContainer = document.getElementById('aiInsightResult');
            
            if (!currentUserProfile) {
                alert("砖 注 驻专驻 转.");
                return;
            }

            aiButton.disabled = true;
            aiButton.innerText = "注 拽砖...";
            aiResultContainer.style.display = 'block';
            aiResultContainer.innerText = '砖... \n壮 转 转 驻专驻 砖,  注砖 拽转 住驻专 砖转.';

            try {
                //  拽专 砖专转 砖 (Backend). 砖专转 砖 拽专 -Gemini.
                const response = await fetch('https://gemini-server.caprover.clicker.co.il/api/get-ai-insight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile: currentUserProfile })
                });

                if (!response.ok) {
                    throw new Error('砖专转 专 砖 住 拽 转转 AI.');
                }

                const aiData = await response.json();
                aiResultContainer.innerText = aiData.insight; // 爪转 转砖 砖专转

            } catch (error) {
                aiResultContainer.innerText = `驻住, 转专砖 砖: ${error.message}`;
            } finally {
                aiButton.disabled = false;
                aiButton.innerText = "爪专 转转 AI ";
            }
        }

        async function findMyResults() {
            const query = searchInput.value.trim();
            if (!query) {
                alert('砖  拽 砖  住驻专 驻');
                return;
            }

            resultsContainer.innerHTML = '<p>驻砖 转 转爪转 砖...</p>';
            
            const isPhoneNumber = /^\d{7,}$/.test(query.replace(/-/g, ''));
            const endpoint = isPhoneNumber 
                ? `/api/my-result/by-phone/${query}` 
                : `/api/my-result/by-code/${query}`;

            try {
                const [resultRes, insightsRes] = await Promise.all([
                    fetch(endpoint),
                    fetch('/api/insights')
                ]);

                if (!resultRes.ok) throw new Error('转爪转  爪.   砖拽  住驻专 驻 .');
                if (!insightsRes.ok) throw new Error('砖 注转  转转.');

                const result = await resultRes.json();
                const insights = await insightsRes.json();
                
                currentUserProfile = result.profile; // **砖: 砖专转 驻专驻 砖砖 注转 (注专 AI)**

                let html = `
                    <h2>砖, ${result.name}!  驻专驻 砖:</h2>
                    <div class="profile-container">
                        ${createProfileChart(result.profile)}
                        ${generateInsightHTML(result.profile, insights)}
                    </div>
                `;
                resultsContainer.innerHTML = html;

                // **砖: 住驻转 event listener 驻转专 -AI 专 砖 爪专**
                document.getElementById('aiInsightButton').addEventListener('click', getAiInsight);

            } catch (error) {
                resultsContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;
                currentUserProfile = null; // 驻住 拽专 砖 砖
            }
        }

        searchButton.addEventListener('click', findMyResults);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                findMyResults();
            }
        });
        
        // **砖: 拽 砖专抓 注转 祝 拽 驻专专 拽砖专**
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const query = params.get('code') || params.get('phone');
            if (query) {
                searchInput.value = query;
                findMyResults();
            }
        });
    </script>
</body>
</html>